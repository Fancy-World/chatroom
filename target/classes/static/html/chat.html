<html>

<head>
    <meta charset="utf-8">
    <title>ç§ä¿¡</title>
    <link rel="stylesheet" href="http://localhost:8080/chatroom/css/semantic.min.css">
    <link rel="stylesheet" href="http://localhost:8080/chatroom/css/chat.css">
    <script type="text/javascript" src="http://localhost:8080/chatroom/js/jquery.js"></script>
    <script type="text/javascript" src="http://localhost:8080/chatroom/js/semantic.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            //å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æœ¬é¡µæˆ–è€…åˆ·æ–°æœ¬é¡µæ—¶ï¼Œç”Ÿæˆid
            //å¼•å¯¼ç”¨æˆ·è¾“å…¥åå­—
            $("#inputname").hide();
            $("#cover").hide();
            var id = parseInt(Math.random()*100);
            var name = "";
            var index = -1;
            //ç‚¹å‡»å‘é€ï¼Œå‘é€ä¿¡æ¯
            $("#send").click(function () {
                if(name === ""){
                    alert("è¯·è¾“å…¥åç§°");
                    $("#cover").show();
                    $("#inputname").show();
                    return;
                }
                var text = $("textarea").val();
                if (text == "") {
                    alert("è¯´äº›ä»€ä¹ˆå§");
                } else {
                    console.log(text);
                    var content = $("textarea").val();
                    $.ajax({
                        //https://book.feelyou.top/search/
                        url: "http://localhost:8080/chatroom/send?name=" + name + "&content=" + content +"&uid=" + id ,
                        async: true,
                        dataType: "json",
                        success: function (data) {
                            console.log(data);

                        }
                    })
                    $("textarea").val("");
                    getMessage();
                }
            });

            //æ¯éš”ä¸€æ®µæ—¶é—´ä»æœåŠ¡å™¨è·å–æ•°æ®
            function getMessage(){
                $.ajax({
                    url:"http://localhost:8080/chatroom/get?index="+index,
                    async:false,
                    dataType: "json",
                    success: function(data){
                        if(data != undefined && data != null && data.length != 0){

                            index = data.length + index;
                            for(var i = 0 ; i <data.length ; i++){
                                console.log(data[i]);
                                createCard(data[i]);
                            }
                        }
                    }
                })
            }

            //åˆ·æ–°æ—¶æ‰§è¡ŒgetMessage();
            getMessage();
            setInterval(getMessage,1000);

            //getMessage();
            //æäº¤åå­—çš„å‡½æ•°
            $("#tijiao").click(function(){
                var text = $("#nameinput").val();
                name = text;
                $("#inputname").hide();
                $("#cover").hide();
            });

            /**
             * <div class="chat-not-me">
                    <div class="others-name">æ–°å£ç»“è¡£</div>
                    <div class="chat-words">
             äº²çˆ±çš„ï¼Œæ™šä¸Šæ—©ç‚¹å›æ¥å‘¦ğŸ˜Š
                    </div>
               </div>
             * @param text
             */
            //åˆ¶ä½œä¿¡æ¯çš„å‡½æ•°
            function createCard(obj) {
                var tempObj = JSON.parse(obj);

                var chat = document.createElement("div");
                var userName = document.createElement("div");
                var chatWords = document.createElement("div");
                if(tempObj.uid === id){
                    chat.className = "chat-me";
                    userName.className = "myname";
                    chatWords.className = "my-chat-words";
                } else {
                    chat.className = "chat-not-me";
                    userName.className = "others-name"
                    chatWords.className = "chat-words";
                }

                userName.innerText = tempObj.name;
                chatWords.innerText = tempObj.content;

                chat.appendChild(userName);
                chat.appendChild(chatWords);


                //æ’å…¥
                var chatContent = document.getElementsByClassName("chat-content")[0];
                chatContent.appendChild(chat);
                //div.scrollTop = div.scrollHeight;
                chatContent.scrollTop = chatContent.scrollHeight;
            }

            //å›è½¦å‘é€
            $("textarea").keypress(function (event) {
                if (event.which === 13) {
                    if ($("textarea").val() == "") {
                        alert("è¯´äº›ä»€ä¹ˆå§");
                    } else {
                        $("#send").click();
                    }
                }
                return false;
            })
        });
    </script>
</head>

<body>

    <div id="cover">

    </div>
    <!-- è¾“å…¥åå­—çš„æ¡†æ¡† -->
    <div id="inputname">
        <div style="margin-top:10px;margin-left:16px;font-size:16px;">
            è¯·è¾“å…¥æ˜µç§°
        </div>
        <div class="ui input focus" style="margin-left:20px;margin-top:20px;">
            <input type="text" placeholder="è¾“å…¥æ˜µç§°.." id="nameinput">
            <button class="ui  button" style="margin-left:15px;display: inline;" id="tijiao">æäº¤</button>
        </div>
        
    </div>

    <!-- åˆ†å‰²çº¿ -->
    <div style="height:20px;">

    </div>
    <div class="chat-window">
        <div class="chat-title">
            <span>é˜¿å·´é˜¿å·´èŠå¤©å®¤</span>
        </div>
        <div class="chat-content">
            <div class="chat-time">
                <span>2020å¹´9æœˆ28æ—¥</span>
            </div>
        </div>
        <div class="ui divider"></div>
        <div class="my-send">
            <textarea rows="2" class="textarea" placeholder="è¯´äº›ä»€ä¹ˆå§"></textarea>
            <div class="send-button">
                <button class="ui primary button send-it" id="send">å‘é€</button>
                <span class="send-it-text"></span>
            </div>
        </div>
    </div>
</body>

</html>